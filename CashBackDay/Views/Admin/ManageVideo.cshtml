@using CashBackObject.Models
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    Layout = "_LayoutAdmin";
    ViewData["Title"] = "Quản Lý Video";
    List<Video> videos = ViewBag.Videos as List<Video>;
}
<main class="admin-main">
    <!-- Platforms Section  -->
    <h2 class="section-title">
        <i class="fas fa-building me-3"></i>
        Quản lý video
    </h2>
    <div class="section-header" style="display: flex; justify-content: flex-start;">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="revenue-card primary">
                <div class="card-icon">
                    <i class="fa-solid fa-play"></i>
                </div>
                <div class="card-content">
                    <h3 class="card-number">@videos.Count()</h3>
                    <p class="card-label">Tổng số video</p>
                </div>
            </div>
        </div>
        <div class="section-actions">
            <form id="searchVideo">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" class="form-control" name="input" placeholder="Tìm kiếm video...">
                </div>
            </form>
            <!-- <select class="form-select filter-select" id="platformStatusFilter">
                <option value="">Tất cả trạng thái</option>
                <option value="active">Hoạt động</option>
                <option value="inactive">Tạm dừng</option>
                <option value="maintenance">Bảo trì</option>
            </select> -->
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addVideoModal">
                <i class="fas fa-plus me-2"></i>Thêm video mới
            </button>
        </div>
    </div>

    <!-- Platform Statistics Cards  -->

    <div class="admin-card">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-list me-2"></i>
                Danh sách video
            </h5>
            <div class="card-actions">
                <div class="btn-group" role="group">
                    <a asp-controller="Admin" asp-action="ManageVideo" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-sync me-1"></i>Làm mới
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover" id="videoTable">
                    <thead>
                        <tr>
                            <th>Tiêu đề</th>
                            <th>Thể loại</th>
                            <th>Mô tả</th>
                            <th>Ngày tài lên</th>
                            <th>Url</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="videoTableBody">
                        <partial name="Partials/_ListVideoPartial" />
                    </tbody>
                </table>
            </div>
        </div>
        @if(videos.Count() == 0)
        {
            <div class="card-footer">
                <div class="col-md-6">
                    <nav aria-label="Platforms pagination">
                        <ul class="pagination justify-content-end mb-0">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Trước</a>
                            </li>
                            <li class="page-item active">
                                <a class="page-link" href="#">1</a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#">Sau</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        }
    </div>
</main>

<!-- add Platform Modal  -->
<div class="modal fade" id="addVideoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content custom-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="addEditPlatformTitle">Thêm video mới</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="addVideoForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Tiêu đề</label>
                                <input type="text" class="form-control custom-input" name="title">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Thể loại</label>
                                <input type="text" class="form-control custom-input" name="category">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control custom-input" name="description" rows="3" placeholder="Mô tả ..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Link</label>
                        <input type="url" class="form-control custom-input" name="videoUrl" placeholder="https://example.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ảnh</label>
                        <input type="text" class="form-control custom-input" name="imgUrl" placeholder="https://imgURL">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-success" id="saveVideoBtn">Thêm video</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- edit Platform Modal  -->
@foreach (var video in ViewBag.Videos)
{
    <div class="modal fade" id="editVideoModal-@video.VideoId" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content custom-modal">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPlatformTitle">Chỉnh sửa thông tin video</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form class="editVideoForm" data-video-id="@video.VideoId">
                    <div class="modal-body">
                        <input type="hidden" value="@video.VideoId" name="videoId" />
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tiêu đề</label>
                                    <input type="text" class="form-control custom-input" name="title" value="@video.Title">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Thể loại</label>
                                    <input type="text" class="form-control custom-input" name="category" value="@video.Category">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả</label>
                            <textarea class="form-control custom-input" name="description" rows="3" placeholder="Mô tả...">@video.Description</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Website</label>
                            <input type="url" class="form-control custom-input" name="videoUrl" placeholder="https://example.com" value="@video.VideoUrl">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Logo sàn</label>
                            <input type="text" class="form-control custom-input" name="imgUrl" value="@video.ImgUrl">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-success">Lưu video</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- Delete Platform Confirmation Modal  -->
@foreach (var video in ViewBag.Videos)
{
    <div class="modal fade" id="deleteVideoModal-@video.VideoId" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content custom-modal">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận xóa video</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form class="deleteVideoModal" data-video-id="@video.VideoId">
                    <input type="hidden" value="@video.VideoId" name="floorId" />
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Cảnh báo!</strong> Hành động này không thể hoàn tác. Tất cả dữ liệu liên quan đến video này sẽ bị xóa.
                        </div>
                        <p>Bạn có chắc chắn muốn xóa video này không?</p>
                        <div class="mb-3">
                            <label class="form-label">Video sẽ bị xóa:</label>
                            <input type="text" class="form-control" id="deleteConfirmation" value="@video.Title" readonly>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-danger">Xác nhận xóa</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="script.js"></script>
<script src="admin-platforms.js"></script>


<script>
    // Mobile sidebar toggle
    document.getElementById('sidebarToggle')?.addEventListener('click', function() {
        document.getElementById('adminSidebar').classList.toggle('show');
    });

    // Number animation
    function animateNumbers() {
        const cards = document.querySelectorAll('.card-number[data-target]');
        cards.forEach(card => {
            const target = parseInt(card.getAttribute('data-target'));
            const increment = target / 50;
            let current = 0;

            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                card.textContent = Math.floor(current);
            }, 20);
        });
    }

    // Initialize animations
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(animateNumbers, 500);
    });

    // Show toast function
    function showToast(message, type) {
        const toastContainer = document.getElementById('toast-container');
        const toastId = 'toast-' + Date.now();

        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = new bootstrap.Toast(document.getElementById(toastId));
        toastElement.show();

        // Remove toast after 5 seconds
        setTimeout(() => {
            const toastEl = document.getElementById(toastId);
            if (toastEl) {
                toastEl.remove();
            }
        }, 5000);
    }

    $(document).on("submit", ".deleteVideoModal", function (e) {
        e.preventDefault();
        const form = $(this);

        $.ajax({
            url: '/Video/Delete',
            type: 'DELETE',
            data: form.serialize(),
            success: function (data) {
                $('#videoTableBody').html(data);
                showToast("Xóa thành công", "success");

                // Ẩn modal đúng cách
                const modalEl = form.closest('.modal')[0];
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                // Cleanup khi modal đóng
                $(modalEl).on('hidden.bs.modal', function () {
                    $('.modal-backdrop').remove();
                    $('body').removeClass('modal-open').css({ overflow: 'auto', paddingRight: '' });
                });
            },
            error: function () {
                showToast("Có lỗi xảy ra khi xóa", "error");
            }
        });
    });

    $(document).on("submit", ".editPlatformForm", function (e) {
        e.preventDefault();
        const form = $(this);

        $.ajax({
            url: '/Video/Edit',
            type: 'PUT',
            data: form.serialize(),
            success: function (data) {
                $('#videoTableBody').html(data);
                showToast("Cập nhật thành công", "success");

                // Ẩn modal đúng cách
                const modalEl = form.closest('.modal')[0];
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                // Cleanup khi modal đóng
                $(modalEl).on('hidden.bs.modal', function () {
                    $('.modal-backdrop').remove();
                    $('body').removeClass('modal-open').css({ overflow: 'auto', paddingRight: '' });
                });
            },
            error: function () {
                showToast("Có lỗi xảy ra khi cập nhật", "error");
            }
        });
    });

        $(document).ready(function () {
        $('#addVideoForm').submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/Video/Add',
                type: 'POST',
                data: $(this).serialize(),
                success: function (data) {
                    $('#videoTableBody').html(data);
                    showToast("Thêm thành công!", "success");

                    const modalEl = form.closest('.modal')[0];
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();

                    // Cleanup khi modal đóng
                    $(modalEl).on('hidden.bs.modal', function () {
                        $('.modal-backdrop').remove();
                        $('body').removeClass('modal-open').css({ overflow: 'auto', paddingRight: '' });
                    });
                },
                error: function () {
                    showToast("Có lỗi xảy ra!", "error");
                }
            });
        });

        $('#searchVideo').submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/Video/Search',
                type: 'GET',
                data: $(this).serialize(),
                success: function (data) {
                    $('#videoTableBody').html(data);
                },
                error: function () {
                    showToast("Có lỗi xảy ra!", "error");
                }
            });
        });
    });
</script>