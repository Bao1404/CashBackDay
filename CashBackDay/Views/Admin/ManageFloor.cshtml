@using CashBackObject.Models
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Quản lý sàn giao dịch";
    List<TradingFloor> tradingFloors = ViewBag.Floors as List<TradingFloor>;
}
<main class="admin-main">
    <!-- Platforms Section  -->
    <h2 class="section-title">
        <i class="fas fa-building me-3"></i>
        Quản lý sàn giao dịch
    </h2>
    <div class="section-header" style="display: flex; justify-content: flex-start;">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="revenue-card primary">
                <div class="card-icon">
                    <i class="fas fa-building"></i>
                </div>
                <div class="card-content">
                    <h3 class="card-number">@tradingFloors.Count()</h3>
                    <p class="card-label">Tổng số sàn</p>
                </div>
            </div>
        </div>
        <div class="section-actions">
            <form id="searchFloor">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" class="form-control" name="input" placeholder="Tìm kiếm sàn giao dịch...">
                </div>
            </form>
            <!-- <select class="form-select filter-select" id="platformStatusFilter">
                <option value="">Tất cả trạng thái</option>
                <option value="active">Hoạt động</option>
                <option value="inactive">Tạm dừng</option>
                <option value="maintenance">Bảo trì</option>
            </select> -->
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addPlatformModal">
                <i class="fas fa-plus me-2"></i>Thêm sàn mới
            </button>
        </div>
    </div>

    <!-- Platform Statistics Cards  -->

    <div class="admin-card">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-list me-2"></i>
                Danh sách sàn giao dịch
            </h5>
            <div class="card-actions">
                <div class="btn-group" role="group">
                    <a asp-controller="Admin" asp-action="ManageUser" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-sync me-1"></i>Làm mới
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover" id="platformsTable">
                    <thead>
                        <tr>
                            <th>Sàn giao dịch</th>
                            <th>Mã giới thiệu</th>
                            <th>Tỷ lệ hoàn tiền</th>
                            <th>Ngày tích hợp</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="platformsTableBody">
                        <partial name="Partials/_ListFloorPartial" />
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer">

                <div class="col-md-6">
                    <nav aria-label="Platforms pagination">
                        <ul class="pagination justify-content-end mb-0">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Trước</a>
                            </li>
                            <li class="page-item active">
                                <a class="page-link" href="#">1</a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#">Sau</a>
                            </li>
                        </ul>
                    </nav>
                </div>
        </div>
    </div>
</main>

<!-- add Platform Modal  -->
<div class="modal fade" id="addPlatformModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content custom-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="addEditPlatformTitle">Thêm sàn giao dịch mới</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
                <form id="addPlatformForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tên sàn giao dịch</label>
                                    <input type="text" class="form-control custom-input" name="floorName">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Mã giới thiệu</label>
                                    <input type="text" class="form-control custom-input" name="inviteCode">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tỷ lệ hoàn tiền (%)</label>
                                    <input type="text" class="form-control custom-input" name="refundPercentage">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">API Key</label>
                                    <input type="text" class="form-control custom-input" name="apiKey">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Website</label>
                            <input type="url" class="form-control custom-input" name="floorUrl" placeholder="https://example.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả</label>
                            <textarea class="form-control custom-input" name="floorDescription" rows="3" placeholder="Mô tả về sàn giao dịch..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Logo sàn</label>
                        <input type="text" class="form-control custom-input" name="imgUrl" placeholder="https://imgURL">
                        </div>
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-success" id="savePlatformBtn">Thêm sàn</button>
                </div>
                </form>
        </div>
    </div>
</div>

<!-- edit Platform Modal  -->
@foreach (var floor in ViewBag.Floors)
{
    <div class="modal fade" id="editPlatformModal-@floor.FloorId" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content custom-modal">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPlatformTitle">Chỉnh sửa thông tin sàn</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form class="editPlatformForm" data-floor-id="@floor.FloorId">
                <div class="modal-body">
                        <input type="hidden" value="@floor.FloorId" name="floorId"/>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tên sàn giao dịch</label>
                                    <input type="text" class="form-control custom-input" name="floorName" value="@floor.FloorName">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Mã giới thiệu</label>
                                    <input type="text" class="form-control custom-input" name="inviteCode" value="@floor.InviteCode">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tỷ lệ hoàn tiền (%)</label>
                                    <input type="text" class="form-control custom-input" name="refundPercentage" value="@floor.RefundPercentage" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Ngày thêm</label>
                                    <input type="text" class="form-control custom-input" name="addedDate" value="@floor.AddedDate?.ToString("dd/MM/yyyy")" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Website</label>
                            <input type="url" class="form-control custom-input" name="floorUrl" placeholder="https://example.com" value="@floor.FloorUrl">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả</label>
                            <textarea class="form-control custom-input" name="floorDescription" rows="3" placeholder="Mô tả về sàn giao dịch...">@floor.FloorDescription</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Logo sàn</label>
                            <input type="text" class="form-control custom-input" name="imgUrl" value="@floor.ImgUrl">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-success">Lưu sàn</button>
                </div>
                 </form>
            </div>
        </div>
    </div>
}

<!-- Delete Platform Confirmation Modal  -->
@foreach (var floor in ViewBag.Floors)
{
    <div class="modal fade" id="deletePlatformModal-@floor.FloorId" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content custom-modal">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận xóa sàn giao dịch</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form class="deletePlatformModal" data-floor-id="@floor.FloorId">
                    <input type="hidden" value="@floor.FloorId" name="floorId" />
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Cảnh báo!</strong> Hành động này không thể hoàn tác. Tất cả dữ liệu liên quan đến sàn này sẽ bị xóa.
                        </div>
                        <p>Bạn có chắc chắn muốn xóa sàn giao dịch này không?</p>
                        <div class="mb-3">
                            <label class="form-label">Sàn sẽ bị xóa:</label>
                            <input type="text" class="form-control" id="deleteConfirmation" value="@floor.FloorName" readonly>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-danger">Xác nhận xóa</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>     
<script src="script.js"></script>
<script src="admin-platforms.js"></script>


<script>
    // Mobile sidebar toggle
    document.getElementById('sidebarToggle')?.addEventListener('click', function() {
        document.getElementById('adminSidebar').classList.toggle('show');
    });

    // Number animation
    function animateNumbers() {
        const cards = document.querySelectorAll('.card-number[data-target]');
        cards.forEach(card => {
            const target = parseInt(card.getAttribute('data-target'));
            const increment = target / 50;
            let current = 0;

            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                card.textContent = Math.floor(current);
            }, 20);
        });
    }

    // Initialize animations
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(animateNumbers, 500);
    });

    // Show toast function
    function showToast(message, type) {
        const toastContainer = document.getElementById('toast-container');
        const toastId = 'toast-' + Date.now();
        
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = new bootstrap.Toast(document.getElementById(toastId));
        toastElement.show();
        
        // Remove toast after 5 seconds
        setTimeout(() => {
            const toastEl = document.getElementById(toastId);
            if (toastEl) {
                toastEl.remove();
            }
        }, 5000);
    }

    $(document).on("submit", ".deletePlatformModal", function (e) {
        e.preventDefault();
        const form = $(this);

        $.ajax({
            url: '/Floor/Delete',
            type: 'DELETE',
            data: form.serialize(),
            success: function (data) {
                $('#platformsTableBody').html(data);
                showToast("Xóa thành công", "success");

                // Ẩn modal đúng cách
                const modalEl = form.closest('.modal')[0];
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                // Cleanup khi modal đóng
                $(modalEl).on('hidden.bs.modal', function () {
                    $('.modal-backdrop').remove();
                    $('body').removeClass('modal-open').css({ overflow: 'auto', paddingRight: '' });
                });
            },
            error: function () {
                showToast("Có lỗi xảy ra khi xóa", "error");
            }
        });
    });

    $(document).on("submit", ".editPlatformForm", function (e) {
        e.preventDefault();
        const form = $(this);

        $.ajax({
            url: '/Floor/Edit',
            type: 'PUT',
            data: form.serialize(),
            success: function (data) {
                $('#platformsTableBody').html(data);
                showToast("Cập nhật thành công", "success");

                // Ẩn modal đúng cách
                const modalEl = form.closest('.modal')[0];
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                // Cleanup khi modal đóng
                $(modalEl).on('hidden.bs.modal', function () {
                    $('.modal-backdrop').remove();
                    $('body').removeClass('modal-open').css({ overflow: 'auto', paddingRight: '' });
                });
            },
            error: function () {
                showToast("Có lỗi xảy ra khi cập nhật", "error");
            }
        });
    });

        $(document).ready(function () {
        $('#addPlatformForm').submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/Floor/Add',
                type: 'POST',
                data: $(this).serialize(),
                success: function (data) {
                    $('#platformsTableBody').html(data);
                    showToast("Thêm thành công!", "success");

                    const modalEl = form.closest('.modal')[0];
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();

                    // Cleanup khi modal đóng
                    $(modalEl).on('hidden.bs.modal', function () {
                        $('.modal-backdrop').remove();
                        $('body').removeClass('modal-open').css({ overflow: 'auto', paddingRight: '' });
                    });
                },
                error: function () {
                    showToast("Sàn đã tồn tại!", "error");
                }
            });
        });

        $('#searchFloor').submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/Floor/Search',
                type: 'GET',
                data: $(this).serialize(),
                success: function (data) {
                    $('#platformsTableBody').html(data);
                },
                error: function () {
                    showToast("Có lỗi xảy ra!", "error");
                }
            });
        });
    });
</script>